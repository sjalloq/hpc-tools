#!/bin/bash
# Generated by hpc-runner (local scheduler)
{% set lb = '{' %}

# Exit on error
set -e

# Module system initialization
{% if scheduler.module_init_script %}
. {{ scheduler.module_init_script }}
{% else %}
if [ -f /etc/profile.d/modules.sh ]; then
    . /etc/profile.d/modules.sh
elif [ -f /usr/share/Modules/init/bash ]; then
    . /usr/share/Modules/init/bash
elif [ -f /etc/modules/init/bash ]; then
    . /etc/modules/init/bash
fi
{% endif %}

{% if scheduler.purge_modules %}
# Purge modules for clean environment
module purge{% if scheduler.silent_modules %} -s{% endif %}

{% endif %}
{% if job.modules_path %}
# Additional module paths
{% for path in job.modules_path %}
module use {{ path }}
{% endfor %}
{% endif %}

{% if job.modules %}
# Load modules
{% for mod in job.modules %}
module load {{ mod }}{% if scheduler.silent_modules %} -s{% endif %}

{% endfor %}
{% endif %}

{% if job.venv %}
# Activate virtual environment
source {{ job.venv }}/bin/activate
{% endif %}

{% if job.env_prepend %}
# Prepend to environment variables
{% for key, value in job.env_prepend.items() %}
export {{ key }}="{{ value }}${{ lb }}{{ key }}:+:${{ key }}}"
{% endfor %}
{% endif %}

{% if job.env_append %}
# Append to environment variables
{% for key, value in job.env_append.items() %}
export {{ key }}="${{ lb }}{{ key }}:+${{ key }}:}{{ value }}"
{% endfor %}
{% endif %}

{% if job.env_vars %}
# Set custom environment variables
{% for key, value in job.env_vars.items() %}
export {{ key }}="{{ value }}"
{% endfor %}
{% endif %}

{% if stdout_path and merge_output %}
# Redirect stdout and stderr to file
exec > {{ stdout_path }} 2>&1
{% elif stdout_path %}
# Redirect stdout to file
exec > {{ stdout_path }}
{% endif %}
{% if stderr_path and not merge_output %}
# Redirect stderr to file
exec 2> {{ stderr_path }}
{% endif %}

# Execute command
{{ job.command }}
exit $?
