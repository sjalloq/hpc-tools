#!/bin/bash
# Generated by hpc-runner (SGE interactive job)
{% set lb = '{' %}

# Exit on error
set -e

# Module system initialization
{% if scheduler.module_init_script %}
. {{ scheduler.module_init_script }}
{% else %}
if [ -f /etc/profile.d/modules.sh ]; then
    . /etc/profile.d/modules.sh
elif [ -f /usr/share/Modules/init/bash ]; then
    . /usr/share/Modules/init/bash
fi
{% endif %}

{% if scheduler.purge_modules %}
# Purge modules for clean environment
module purge{% if scheduler.silent_modules %} -s{% endif %}

{% endif %}
{% if job.modules_path %}
# Additional module paths
{% for path in job.modules_path %}
module use {{ path }}
{% endfor %}
{% endif %}

{% if job.modules %}
# Load modules
{% for mod in job.modules %}
module load {{ mod }}{% if scheduler.silent_modules %} -s{% endif %}

{% endfor %}
{% endif %}

{% if job.venv %}
# Activate virtual environment
source {{ job.venv }}/bin/activate
{% endif %}

{% if scheduler.unset_vars %}
# Unset environment variables
{% for var in scheduler.unset_vars %}
unset {{ var }}
{% endfor %}
{% endif %}

{% if job.env_prepend %}
# Prepend to environment variables
{% for key, value in job.env_prepend.items() %}
export {{ key }}="{{ value }}${{ lb }}{{ key }}:+:${{ key }}}"
{% endfor %}
{% endif %}

{% if job.env_append %}
# Append to environment variables
{% for key, value in job.env_append.items() %}
export {{ key }}="${{ lb }}{{ key }}:+${{ key }}:}{{ value }}"
{% endfor %}
{% endif %}

{% if job.env_vars %}
# Set custom environment variables
{% for key, value in job.env_vars.items() %}
export {{ key }}="{{ value }}"
{% endfor %}
{% endif %}

{% if scheduler.expand_makeflags %}
# Expand MAKEFLAGS (e.g., -j$NSLOTS)
if [ -n "$MAKEFLAGS" ]; then
    export MAKEFLAGS=$(echo "$MAKEFLAGS" | envsubst)
fi
{% endif %}

# Execute command
{{ job.command }}
_exit_code=$?

{% if not keep_script %}
# Cleanup temporary script
rm -f {{ script_path }}
{% endif %}

exit $_exit_code
